#!/usr/local/bin/perl
# -*- coding: utf-8; mode:cperl -*-

package MilterOption;

use Moose;
use Moose::Util::TypeConstraints;
with 'MooseX::Getopt';

subtype 'ManagerOption::MaxChildren',
    as 'Int',
    where { $_ >= 0 },
    message { 'max-children must be plus integer' };

subtype 'ManagerOption::MaxRequests',
    as 'Int',
    where { $_ >= 0 },
    message { 'max-requests must be plus integer' };

has 'basedir'      => ( isa => 'Str',  is => 'ro', default => '/var/run/smtpauth' );
has 'logdir'       => ( isa => 'Str',  is => 'ro', default => '/var/log/smtpauth' );
has 'foreground'   => ( isa => 'Bool', is => 'ro', default => 0 );
has 'max_children' => ( isa => 'ManagerOption::MaxChildren', is => 'ro', default => 0 );
has 'max_requests' => ( isa => 'ManagerOption::MaxRequests', is => 'ro', default => 1000 );

no Moose;
__PACKAGE__->meta->make_immutable;

package main;

use strict;
use warnings;
use English;
use POSIX;
use IO::File;
use Sys::Syslog;
use Milter::SMTPAuth;
use Milter::SMTPAuth::Utils;

my $option = MilterOption->new_with_options();

my $pid_file      = sprintf( "%s/pid",         $option->basedir() );
my $filter_socket = sprintf( "%s/filter.sock", $option->basedir() );
my $logger_socket = sprintf( "unix:%s/logger.sock", $option->basedir() );
my $log_file      = sprintf( "%s/stats.log",   $option->logdir() );

openlog( 'smtp-manager', 'pid,nowait', 'mail' );
syslog( 'info', 'starting manager' );

if ( ! -d $option->basedir ) {
    mkdir( $option->basedir );
    chmod( 0755, $option->basedir );
}
if ( ! -d $option->logdir ) {
    mkdir( $option->logdir );
    chmod( 0755, $option->logdir );
}

if ( ! $option->foreground() ) {
    Milter::SMTPAuth::Utils::daemonize( $pid_file );
}

my $manager = new Milter::SMTPAuth(
    processes => [
        new Milter::SMTPAuth::Child(
            command     => 'smtpauth-log-collector',
            arguments   => [
                '--recv_address', $logger_socket,
                '--log',          $log_file,
                '--foreground',
            ],
            signal_stop => 10,          # SIGUSR1
        ),
        new Milter::SMTPAuth::Child(
            command   => 'smtpauth-filter',
            arguments => [
                '--listen_path',    $filter_socket,
                '--logger_address', $logger_socket,
                '--max_children',   $option->max_children(),
                '--max_requests',   $option->max_requests(),
                '--foreground',
            ]
        ),
    ]
);
$SIG{TERM} = $SIG{INT} = sub {
    $manager->stop();
    if ( -f $pid_file ) {
	unlink( $pid_file );
    }
};

$manager->start();
